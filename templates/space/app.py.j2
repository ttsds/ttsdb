"""{{ model_name }} - HuggingFace Space Demo

A Gradio interface for {{ model_name }} text-to-speech synthesis.
"""

import os
import tempfile
from pathlib import Path

import gradio as gr
import numpy as np

from {{ import_name }} import {{ class_name }}

# Initialize model (downloads weights on first run)
MODEL_ID = os.environ.get("MODEL_ID", "ttsds/{{ folder_name }}")
model = None


def load_model():
    """Lazy load the model."""
    global model
    if model is None:
        model = {{ class_name }}(model_id=MODEL_ID)
    return model


def synthesize(
    text: str,
    reference_audio: str,
    reference_text: str,
    language: str,
) -> tuple[int, np.ndarray]:
    """Synthesize speech from text.
    
    Args:
        text: Text to synthesize.
        reference_audio: Path to reference audio file.
        reference_text: Transcript of reference audio.
        language: Language code (ISO 639-3).
        
    Returns:
        Tuple of (sample_rate, audio_array).
    """
    if not text.strip():
        raise gr.Error("Please enter some text to synthesize.")
    
    if not reference_audio:
        raise gr.Error("Please upload a reference audio file.")
    
    if not reference_text.strip():
        raise gr.Error("Please enter the transcript of the reference audio.")
    
    m = load_model()
    
    audio, sr = m.synthesize(
        text=text,
        reference_audio=reference_audio,
        text_reference=reference_text,
        language=language,
    )
    
    return (sr, audio)


# Build the Gradio interface
with gr.Blocks(title="{{ model_name }} TTS") as demo:
    # Header
    gr.Markdown(
        """
        # {{ model_name }} Text-to-Speech
        
{% if description %}
{{ description }}

{% else %}
        Clone any voice with just a few seconds of reference audio.
{% endif %}
        
        > **Note:** This demo is not affiliated with or endorsed by the original authors.
        > It is provided for research and educational purposes only.
        
        **Links:** [Code]({{ code_url }}){% for url in paper_urls %} | [Paper]({{ url }}){% endfor %}{% if weights_url %} | [Weights]({{ weights_url }}){% endif %}
        
        ---
        
        ## How to use:
        1. Upload a reference audio clip (3-10 seconds recommended)
        2. Enter the transcript of what's being said in the reference
        3. Enter the text you want to synthesize
        4. Select the language
        5. Click "Synthesize"
        """
    )
    
    with gr.Row():
        with gr.Column():
            reference_audio = gr.Audio(
                label="Reference Audio",
                type="filepath",
            )
            reference_text = gr.Textbox(
                label="Reference Transcript",
                placeholder="Enter what is being said in the reference audio...",
                lines=2,
            )
            text_input = gr.Textbox(
                label="Text to Synthesize",
                placeholder="Enter the text you want to convert to speech...",
                lines=3,
            )
            language = gr.Dropdown(
                label="Language",
                choices=[
{% for name, code in language_choices %}
                    ("{{ name }}", "{{ code }}"),
{% endfor %}
                ],
                value="{{ language_codes[0] if language_codes else 'eng' }}",
            )
            submit_btn = gr.Button("Synthesize", variant="primary")
        
        with gr.Column():
            output_audio = gr.Audio(
                label="Synthesized Audio",
                type="numpy",
            )
    
    # Example inputs from test_data.yaml
    gr.Examples(
        examples=[
{% for example in examples %}
{% if example.reference_audio %}
            ["{{ example.reference_audio }}", "{{ example.reference_text }}", "{{ example.text }}", "{{ example.language }}"],
{% endif %}
{% endfor %}
        ],
        inputs=[reference_audio, reference_text, text_input, language],
    )
    
    submit_btn.click(
        fn=synthesize,
        inputs=[text_input, reference_audio, reference_text, language],
        outputs=[output_audio],
    )
    
    # Footer with model information and citations
    gr.Markdown(
        """
        ---
        
        ## Model Information
        
        | Property | Value |
        |----------|-------|
        | **Architecture** | {{ architecture | join(", ") }} |
        | **Sample Rate** | {{ sample_rate }} Hz |
        | **Parameters** | {{ num_parameters }}M |
        | **Languages** | {{ language_names | join(", ") }} |
{% if release_date %}
        | **Release Date** | {{ release_date }} |
{% endif %}
        
{% if citations %}
        ## Citations
        
        If you use this model, please cite the original work:
        
{% for citation in citations %}
        ```bibtex
{{ citation.text }}
        ```
{% endfor %}
{% endif %}
        """
    )


if __name__ == "__main__":
    # HuggingFace Spaces exposes the service via $PORT and requires binding to 0.0.0.0
    port = int(os.environ.get("PORT", "7860"))
    demo.launch(server_name="0.0.0.0", server_port=port, share=False)
