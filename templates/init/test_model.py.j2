"""Tests for {{ model_name }}."""

import pytest
from ttsdb_core import ModelConfig


class TestConfig:
    """Test config loading."""
    
    def test_config_loads_from_package(self):
        """Config should load from the package."""
        config = ModelConfig.from_package("{{ import_name }}")
        assert config is not None
    
    def test_config_has_metadata(self):
        """Config should have metadata section."""
        config = ModelConfig.from_package("{{ import_name }}")
        assert "metadata" in config
        assert config.metadata.name == "{{ model_name }}"
    
    def test_config_has_sample_rate(self):
        """Config should specify sample rate."""
        config = ModelConfig.from_package("{{ import_name }}")
        assert config.metadata.sample_rate > 0


class TestModelImport:
    """Test model class imports."""
    
    def test_model_class_importable(self):
        """Model class should be importable."""
        from {{ import_name }} import {{ class_name }}
        assert {{ class_name }} is not None
    
    def test_model_has_package_name(self):
        """Model should have _package_name set."""
        from {{ import_name }} import {{ class_name }}
        assert {{ class_name }}._package_name == "{{ import_name }}"


# Integration tests - require model weights to be downloaded
@pytest.mark.integration
class TestModelIntegration:
    """Integration tests for {{ model_name }} synthesis.
    
    These tests require:
    - Model weights to be downloaded (run: just hf prepare {{ folder_name }})
    
    Run with: just test-integration {{ folder_name }}
    """
    
    @pytest.fixture
    def model(self, weights_path):
        """Load the {{ model_name }} model from local weights directory."""
        from {{ import_name }} import {{ class_name }}
        
        if not weights_path.exists():
            pytest.skip(f"Weights not found at {weights_path}. Run: just hf prepare {{ folder_name }}")
        
        return {{ class_name }}(model_path=str(weights_path))
    
    def test_model_loads(self, model):
        """Model should load successfully."""
        assert model is not None
        assert model.model is not None
    
    def test_synthesize_returns_audio(self, model, reference_audio, test_data):
        """Synthesis should return audio array and sample rate."""
        sentences = test_data.get("test_sentences", {}).get("en", [])
        if not sentences:
            pytest.skip("No test sentences found")
        
        text = sentences[0]["text"]
        audio, sr = model.synthesize(
            text=text,
            reference_audio=reference_audio["path"],
            text_reference=reference_audio["text"],
            language=reference_audio["language"],
        )
        
        assert audio is not None
        assert len(audio) > 0
        assert sr > 0
    
    def test_generate_audio_examples(self, model, reference_audio, test_data, audio_examples_dir):
        """Generate audio examples and save to audio_examples/ directory."""
        import soundfile as sf
        
        sentences = test_data.get("test_sentences", {}).get("en", [])
        if not sentences:
            pytest.skip("No test sentences found")
        
        for i, sentence in enumerate(sentences):
            text = sentence["text"]
            audio, sr = model.synthesize(
                text=text,
                reference_audio=reference_audio["path"],
                text_reference=reference_audio["text"],
                language=reference_audio["language"],
            )
            
            # Save the audio
            output_path = audio_examples_dir / f"en_test_{i+1:03d}.wav"
            sf.write(str(output_path), audio, sr)
            print(f"Saved: {output_path}")
            
            assert output_path.exists()
            assert output_path.stat().st_size > 0
